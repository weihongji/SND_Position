@model MapMgmtModel
@{
    ViewBag.Title = "Index";
}

<style type="text/css">
    body {
        font-size: 62.5%;
    }

    .selected {
        background-color: gray;
    }

    .highlight {
        background-color: lightgray;
    }

    .ui-menu {
        width: 80px;
        z-index: 1000;
    }

        .ui-menu > li > a {
            font-size: 12px;
        }

    /*dialog form*/
    #dialog-form label, #dialog-form input {
        display: block;
    }

        #dialog-form input.text {
            margin-bottom: 12px;
            width: 95%;
            padding: .4em;
        }

    #dialog-form fieldset {
        padding: 0;
        border: 0;
        margin-top: 25px;
    }

    #dialog-form .ui-dialog .ui-state-error {
        padding: .3em;
    }
</style>

<h2>Index</h2>
<div>@Html.ActionLink("SunSet", "SunSet")</div>
<div>
    <button>Zoom Out</button>
    <button>Fit</button>
    <button>Zoom In</button>
    <button id="btnClearConsole">Clear Console</button>
</div>
<div>
    <div id="divMine" style="border: 1px solid red; float: left; position: relative;">
        <img id="imgMine" style="border: 1px dotted black;" src="~/Images/@(Model.Map.Name)" draggable="false" />
        <div id="divPinPanel">
            <img pin_type="1" id="imgPinBlue" style="position: absolute; left: 1028px; top: -1px;" src="~/Images/Pins/pin-blue.png" />
            <img pin_type="2" id="imgPinRed" style="position: absolute; left: 1027px; top: 63px;" src="~/Images/Pins/pin-red.png" />
            <img pin_type="3" id="imgPinGreen" style="position: absolute; left: 1028px; top: 126px;" src="~/Images/Pins/pin-green.png" />
        </div>
        <div id="divPinLocated">
            @foreach (var pin in Model.MonitorList) {
                <img id="pin_@(pin.Id)" pinned="1" title="@pin.ToString()"
                    pin_id="@pin.Id"
                    pin_name="@pin.Name"
                    pin_info="@pin.Information"
                    pin_alarmup="@pin.AlarmUp"
                    pin_alarmdown="@pin.AlarmDown"
                    pin_rangeup="@pin.RangeUp"
                    pin_rangedown="@pin.RangeDown"
                    pin_x="@pin.X"
                    pin_y="@pin.Y"
                    pin_type="@pin.MonitorTypeId"
                    style="position: absolute; left: @(pin.Left)px; top: @(pin.Top)px;" src="~/Images/Pins/@(pin.Image)" />
            }
        </div>
        <!--Context Menu-->
        <ul id="menu">
            <li><a href="#">Edit</a></li>
            <li><a href="#">Delete</a></li>
        </ul>
        <!--Edit Dialog-->
        <div id="dialog-form" title="编辑风压检测站">
            <form>
                <fieldset>
                    <label for="field_name">名称</label>
                    <input type="text" name="field_name" id="field_name" class="text ui-widget-content ui-corner-all" />
                    <label for="field_info">信息</label>
                    <input type="text" name="field_info" id="field_info" class="text ui-widget-content ui-corner-all" />
                    <label for="field_alarmup">报警上限</label>
                    <input type="text" name="field_alarmup" id="field_alarmup" class="text ui-widget-content ui-corner-all" />
                    <label for="field_alarmdown">报警下限</label>
                    <input type="text" name="field_alarmdown" id="field_alarmdown" class="text ui-widget-content ui-corner-all" />
                    <label for="field_rangeup">量程上限</label>
                    <input type="text" name="field_rangeup" id="field_rangeup" class="text ui-widget-content ui-corner-all" />
                    <label for="field_rangedown">量程下限</label>
                    <input type="text" name="field_rangedown" id="field_rangedown" class="text ui-widget-content ui-corner-all" />
                    <input type="hidden" name="field_id" id="field_id" />
                    <input type="hidden" name="field_x" id="field_x" />
                    <input type="hidden" name="field_y" id="field_y" />
                    <input type="hidden" name="field_type" id="field_type" />
                </fieldset>
            </form>
        </div>
    </div>
    <div id="divIcons" style="border: 1px solid black; float: left; cursor: pointer; width: 35px;">
        <div style="background-image: url(Images/Pins/pin-black.png); background-repeat: no-repeat; height: 63px;"></div>
        <div style="background-image: url(Images/Pins/pin-black.png); background-repeat: no-repeat; height: 63px;"></div>
        <div style="background-image: url(Images/Pins/pin-black.png); background-repeat: no-repeat; height: 63px;"></div>
    </div>
    <div id="divConsole" style="float: left; padding-left: 10px;"></div>
    <div style="clear: both;"></div>
</div>
<link href="~/Content/themes/smoothness/jquery-ui-1.10.3.custom.css" rel="stylesheet" />
<script src="~/Scripts/jquery-1.9.1.js"></script>
<script src="~/Scripts/jquery-ui-1.10.3.custom.js"></script>

<script type="text/javascript">
    var _pinOnSeat;
    var _clickedPin;
    var _maxPinIndex = 0;

    //Image attributes
    var _map_width, _map_height;
    var _pin_width, _pin_height;

    $(function () {
        _map_width = $("#imgMine").width();
        _map_height = $("#imgMine").height();

        //Context Menu
        $("#menu").menu().css("position", "absolute").hide();
        $("#menu>li:eq(0)").click(function () {
            $("#menu").hide();
            $("#field_id").val(_clickedPin.attr("pin_id"));
            $("#field_name").val(_clickedPin.attr("pin_name"));
            $("#field_info").val(_clickedPin.attr("pin_info"));
            $("#field_alarmup").val(_clickedPin.attr("pin_alarmup"));
            $("#field_alarmdown").val(_clickedPin.attr("pin_alarmdown"));
            $("#field_rangeup").val(_clickedPin.attr("pin_rangeup"));
            $("#field_rangedown").val(_clickedPin.attr("pin_rangedown"));
            $("#field_x").val(_clickedPin.attr("pin_x"));
            $("#field_y").val(_clickedPin.attr("pin_y"));
            $("#field_type").val(_clickedPin.attr("pin_type"));
            $("#dialog-form").dialog("open");
            return false;
        });
        $("#menu>li:eq(1)").click(function () {
            $("#menu").hide();
            deleteMonitor(_clickedPin);
            return false;
        });
        $("#divMine")
            .contextmenu(null, function (e) {
                if ($(e.target).attr("pinned")) {
                    _clickedPin = $(e.target);
                    var left = parseInt(_clickedPin.css("left")) + _clickedPin.width() / 3;
                    var top = parseInt(_clickedPin.css("top")) + _clickedPin.height() / 3;
                    $("#menu").css({ left: left + "px", top: top + "px" }).show();
                }
                return false;
            })
            .click(function () {
                $("#menu").hide(50);
            });

        //Pin Panel
        $("#divIcons>div")
            .mouseover(function () {
                if (!$(this).hasClass("selected")) {
                    $(this).addClass("highlight");
                }
            })
            .mouseout(function () {
                $(this).removeClass("highlight");
            })
            .click(function () {
                $("#divIcons>div").removeClass("selected highlight");
                $(this).addClass("selected");
            });

        //Pin Draggable
        $("#divPinPanel>img").add("#divPinLocated>img").each(function () {
            makeItDraggable(this);
        });

        //Debug Console
        $("#btnClearConsole").click(function () {
            location.reload(true);
        });

        //Edit Dialog
        $("#dialog-form").dialog({
            autoOpen: false,
            height: 450,
            width: 400,
            modal: true,
            buttons: {
                Save: function () {
                    var bValid = true;
                    if (bValid) {
                        saveMonitor();
                    }
                },
                Cancel: function () {
                    $(this).dialog("close");
                }
            },
            close: function () {
                $("#dialog-form :text").val("").removeClass("ui-state-error");
            }
        });
    });

    function makeItDraggable(o) {
        $(o).draggable({
            cursor: "move",
            start: function () {
                if (!$(this).attr("pinned")) {
                    _pinOnSeat = $(this).clone();
                }
            },
            drag: function () {
                $(this).draggable("option", "revert", !isInBoundary(this));
            },
            stop: function () {
                if (!$(this).draggable("option", "revert")) {
                    if (!$(this).attr("pinned")) {
                        $(this).removeAttr("id").attr("pinned", 1).appendTo($("#divPinLocated"));
                        $(_pinOnSeat).appendTo($("#divPinPanel"));
                        makeItDraggable($(_pinOnSeat));
                    }
                    savePosition(this);
                    logPosition(this);
                }
            }
        });
    }

    function isInBoundary(pinImage) {
        //For efficience reson, we are calculating the pin's position ourself in this function.
        var o = $(pinImage);
        var x = parseInt(o.css("left"));
        var padding = 10;
        if (!isNaN(x) && padding < x && x < _map_width - padding) {
            var y = parseInt(o.css("top"));
            if (!isNaN(y)) {
                y += o.height();
                if (padding < y && y < _map_height - padding) {
                    return true;
                }
            }
        }
        return false;
    }

    function savePosition(o) {
        o = $(o);
        var url = "@Url.Action("SaveMonitorPointPosition")";
        var monitor = {
            id: safeParseInt(o.attr("pin_id")),
            left: safeParseInt(o.css("left")),
            top: safeParseInt(o.css("top")),
            typeId: safeParseInt(o.attr("pin_type"))
        };
        $.getJSON(url, monitor, function (data) {
            if (data.success) {
                o.attr("pin_id", data.entity.Id);
                o.attr("pin_x", data.entity.X);
                o.attr("pin_y", data.entity.Y);
                o.attr("pin_type", data.entity.MonitorTypeId);
                o.attr("title", data.title);
            }
            else {
                alert("保存检测点时报错。内容：\n" + data.message);
            }
        });
    }

    function saveMonitor() {
        o = $(_clickedPin);
        var url = "@Url.Action("SaveMonitorPoint")";
        var monitor = {
            Id: safeParseInt(o.attr("pin_id")),
            Name: $("#field_name").val(),
            Information: $("#field_info").val(),
            AlarmUp: $("#field_alarmup").val(),
            AlarmDown: $("#field_alarmdown").val(),
            RangeUp: $("#field_rangeup").val(),
            RangeDown: $("#field_rangedown").val(),
            X: $("#field_x").val(),
            Y: $("#field_y").val(),
            MonitorTypeId: $("#field_type").val()
        };

        $.getJSON(url, monitor, function (data) {
            if (data.success) {
                o.attr("pin_id", data.entity.Id);
                o.attr("pin_name", data.entity.Name);
                o.attr("pin_info", data.entity.Information);
                o.attr("pin_alarmup", data.entity.AlarmUp);
                o.attr("pin_alarmdown", data.entity.AlarmDown);
                o.attr("pin_rangeup", data.entity.RangeUp);
                o.attr("pin_rangedown", data.entity.RangeDown);
                o.attr("pin_x", data.entity.X);
                o.attr("pin_y", data.entity.Y);
                o.attr("pin_type", data.entity.MonitorTypeId);
                o.attr("title", data.title);
                $("#dialog-form").dialog("close");
            }
            else {
                alert("保存检测点资料时报错。内容：\n" + data.message);
            }
        });
    }

    function deleteMonitor(o) {
        o = $(o);
        var url = "@Url.Action("DeleteMonitorPoint")";
        if (confirm("确认要删除" + $(o).attr("pin_name") + "吗？")) {
            $.getJSON(url, { id: safeParseInt(o.attr("pin_id")) }, function (data) {
                if (data.success) {
                    $(o).remove();
                }
                else {
                    alert("删除检测点时报错。内容：\n" + data.message);
                }
            });
        }
    }

    function logPosition(pinImage) {
        var p = getPinPosition(pinImage);
        logIt(p);
    }

    function logIt(s) {
        if (s != null) {
            $("#divConsole").append("<div>" + s.toString() + "</div>");
        }
    }

    function getPinPosition(pinImage) {
        var o = $(pinImage);
        var left = parseInt(o.css("left"));
        var top = parseInt(o.css("top"));
        if (isNaN(left) || isNaN(top)) {
            return null;
        }
        else {
            return new Point(left, top + o.height());
        }
    }

    function safeParseInt(value) {
        var result = parseInt(value);
        if (isNaN(result)) {
            result = 0;
        }
        return result;
    }

    function Point(x, y) {
        this.X = x;
        this.Y = y;
        this.toString = function () {
            return "(" + this.X + "," + this.Y + ")";
        }
    }
</script>
